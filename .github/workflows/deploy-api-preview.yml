name: Deploy API (preview)

on:
  push:
    branches:
      - develop
    paths:
      - apps/api/**
      - .github/workflows/deploy-api-preview.yml
  workflow_dispatch:

permissions:
  contents: read
  id-token: write

concurrency:
  group: deploy-api-preview
  cancel-in-progress: true

env:
  AWS_REGION: ${{ vars.DEMODAY_AWS_REGION }}
  S3_BUCKET: ${{ vars.DEMODAY_ARTIFACTS_S3_BUCKET }}
  EC2_INSTANCE_ID: ${{ vars.DEMODAY_API_EC2_INSTANCE_ID }}
  ROLE_TO_ASSUME: ${{ vars.DEMODAY_DEPLOY_ROLE_ARN }}
  HEALTHCHECK_URL: ${{ vars.DEMODAY_API_PREVIEW_HEALTHCHECK_URL }}
  ARTIFACT_PREFIX: ${{ vars.DEMODAY_API_PREVIEW_ARTIFACT_PREFIX }}
  REMOTE_DEPLOY_DIR: ${{ vars.DEMODAY_API_PREVIEW_REMOTE_DEPLOY_DIR }}
  SYSTEMD_SERVICE: ${{ vars.DEMODAY_API_PREVIEW_SYSTEMD_SERVICE }}

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: '21'
          cache: gradle

      - name: Configure AWS credentials (OIDC)
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ env.ROLE_TO_ASSUME }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Ensure gradlew is executable
        run: chmod +x apps/api/gradlew

      - name: Build bootJar (apps/api)
        working-directory: apps/api
        run: ./gradlew bootJar -x test

      - name: Resolve jar path
        id: jar
        run: |
          JAR_PATH="$(ls apps/api/build/libs/*.jar | grep -v plain | head -n 1)"
          echo "path=$JAR_PATH" >> "$GITHUB_OUTPUT"

      - name: Upload jar to S3 (preview)
        run: |
          : "${S3_BUCKET:?S3_BUCKET is required}"
          : "${ARTIFACT_PREFIX:?ARTIFACT_PREFIX is required}"
          aws s3 cp "${{ steps.jar.outputs.path }}" "s3://${S3_BUCKET}/${ARTIFACT_PREFIX}/${GITHUB_SHA}/api.jar"

      - name: Deploy to EC2 via SSM (preview)
        id: deploy
        run: |
          : "${AWS_REGION:?AWS_REGION is required}"
          : "${S3_BUCKET:?S3_BUCKET is required}"
          : "${EC2_INSTANCE_ID:?EC2_INSTANCE_ID is required}"
          : "${ARTIFACT_PREFIX:?ARTIFACT_PREFIX is required}"
          : "${REMOTE_DEPLOY_DIR:?REMOTE_DEPLOY_DIR is required}"
          : "${SYSTEMD_SERVICE:?SYSTEMD_SERVICE is required}"

          COMMAND_ID="$(
            aws ssm send-command \
              --region "$AWS_REGION" \
              --instance-ids "$EC2_INSTANCE_ID" \
              --document-name "AWS-RunShellScript" \
              --comment "Deploy API preview ${GITHUB_SHA}" \
              --parameters "commands=[\"sudo mkdir -p ${REMOTE_DEPLOY_DIR}\",\"sudo aws s3 cp s3://${S3_BUCKET}/${ARTIFACT_PREFIX}/${GITHUB_SHA}/api.jar ${REMOTE_DEPLOY_DIR}/api.jar\",\"sudo systemctl restart ${SYSTEMD_SERVICE}\"]" \
              --query "Command.CommandId" \
              --output text
          )"
          echo "command_id=$COMMAND_ID" >> "$GITHUB_OUTPUT"

          aws ssm wait command-executed \
            --region "$AWS_REGION" \
            --command-id "$COMMAND_ID" \
            --instance-id "$EC2_INSTANCE_ID"

          aws ssm get-command-invocation \
            --region "$AWS_REGION" \
            --command-id "$COMMAND_ID" \
            --instance-id "$EC2_INSTANCE_ID" \
            --query '{Status:Status,StandardOutputContent:StandardOutputContent,StandardErrorContent:StandardErrorContent}'

      - name: Health check (preview)
        run: |
          : "${HEALTHCHECK_URL:?HEALTHCHECK_URL is required}"
          for i in $(seq 1 30); do
            if curl -fsS "$HEALTHCHECK_URL" | grep -q "ok"; then
              echo "Health check OK"
              exit 0
            fi
            sleep 2
          done
          echo "Health check failed"
          exit 1
